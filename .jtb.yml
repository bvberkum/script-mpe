
# Define jobs using JTB templates

- project:
    name: script.mpe

    branch: dev
    vendor-path: dotmpe/script.mpe
    htmlDescription: ''
    project-src: '*.sh,*.py'
    email-to: ''
    build-summary-image:
    email-individuals: false
    credentials-id: 'f3711d97-0c02-4099-b16f-d6d7fe13d168'

    # XXX hacky hack hack
    box,str: '{box,str}'
    bats-tests: '{box,str}'
    # XXX bats-tests: '{{box,str}}'
    # XXX bats-tests: '\{box,str\}'


    jobs:

    #
    # Two partially pre-scripted jobs Using the .travis.yml 
    # build config.
    #
    # FIXME: travis build fails on TB config parts
    # XXX: want to use branch checkout? but not working
    #- '{name}-gh-travis':
    #    disabled: true
    #    title: 'script.mpe [gh,public,travis] ({branch})'

    #- '{name}-local-gh-travis':
    #    disabled: true
    #    title: 'script.mpe [gh,travis] ({branch})'

    #
    # Two custom script Github checkouts for testing.
    # One without and one with TAP test result publishing.
    #

    - '{name}-local-gh':
        disabled: true
        title: 'script.mpe [gh,local,no-test] ({branch})'
        htmlDescription: 'Running some bats test to see if they go, without parsing results'
        credentials-id: 'f1899d66-848f-43e9-83cf-f26f171a1e27'
        restrict-node: ubuntu || treebox
        parameters: []
        properties: []
        metadata: []
        builders:
        - shell: |

            export PATH=$PATH:$HOME/usr/bin/
            bats --version

            rm -rf $HOME/bin
            ln -s $WORKSPACE $HOME/bin
            export PATH=$PATH:$HOME/bin/
            export PYTHON_PATH=$PYTHON_PATH:$HOME/lib/py
            export JTB_HOME=$HOME/build/jtb

            export PREFIX=$WORKSPACE
            export TRAVIS_SKIP=1
            export JENKINS_SKIP=1
            ./box help
            bash -c './test/{bats-tests}-spec.bats'

        publishers:
        - tap:
            results: build/test-results.tap


    - '{name}-local-gh-bats':
        disabled: false
        title: 'script.mpe [gh,local,bats] ({branch})'
        credentials-id: 'f1899d66-848f-43e9-83cf-f26f171a1e27'
        restrict-node: ubuntu || treebox
        bats-tap-results: build/test-results.tap
        parameters:
        - string:
            name: SUITE
            value: main
        properties: []
        metadata: []
        # TODO: fix JJB serialize
        #- string:
        #    name: Build_Deps_Default_Paths
        #    value: on
        #    expose-to-env: false
        builders:
        - shell: |

            export LIB=$WORKSPACE
            ./htd version
            ./htd help

            export PATH=$WORKSPACE:$PATH
            htd version
            box version
            #match.sh -v

        - shell: |
            set +x
            export PATH=$WORKSPACE:$PATH
            export PATH=$HOME/.local/bin:$PATH
            export Build_Deps_Default_Paths=1
            ./install-dependencies.sh test

            bats --version

        #    #export PATH=$PATH:$HOME/usr/bin/
        #    export PATH=$WORKSPACE:$PATH
        #    export PATH=$HOME/.local/bin:$PATH

        #    rm -rf $HOME/bin
        #    ln -s $WORKSPACE $HOME/bin
        #    export PATH=$PATH:$HOME/bin/
        #    export JTB_HOME=$HOME/build/jtb

        - shell: |
            set +x

            export PATH=$WORKSPACE:$PATH
            export PATH=$HOME/.local/bin:$PATH
            export LIB=$WORKSPACE
            export PREFIX=
            export TRAVIS_SKIP=1
            export JENKINS_SKIP=1
            export PYTHON_PATH=$PYTHON_PATH:$HOME/lib/py

            mkdir -vp ./build

            test -n "$SUITE" && {{
              SPECS=
              for SPEC in $SUITE
              do
                SPECS="$SPECS ./test/$SPEC-spec.bats"
              done
            }} || test -n "$SPEC" && {{
              SPECS="./test/$SPEC-spec.bats"
            }} || {{
              SPECS=./test/*-spec.bats
            }}

            bats $SPECS || exit 0 > ./build/test-results.tap

    #
    # A job to test/update this build config file, if either JJB, JTB or
    # this repo changes.
    #


